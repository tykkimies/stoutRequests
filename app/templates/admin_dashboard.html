{% extends "base.html" %}

{% block title %}Admin Dashboard - Stout Requests{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                <p class="text-gray-600 mt-1">Manage your Stout Requests server settings and users</p>
            </div>
            <a href="{{ base_url }}/" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                ← Back to Discover
            </a>
        </div>

        <!-- Success/Error Messages -->
        {% if request.query_params.get('success') %}
        <div id="admin-success-message" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
            <div class="flex">
                <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <p class="ml-3 text-sm text-green-700">{{ request.query_params.get('success') }}</p>
            </div>
        </div>
        {% endif %}

        {% if request.query_params.get('error') %}
        <div id="admin-error-message" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
            <div class="flex">
                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <p class="ml-3 text-sm text-red-700">{{ request.query_params.get('error') }}</p>
            </div>
        </div>
        {% endif %}

        <!-- HTMX Tab Navigation -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button hx-get="{{ base_url }}/admin/tabs/overview" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=overview"
                        data-tab="overview"
                        class="admin-tab-btn border-primary-500 text-primary-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    📊 Overview
                </button>
                {% if user_permissions.can_manage_users %}
                <button hx-get="{{ base_url }}/admin/tabs/users" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=users"
                        data-tab="users"
                        class="admin-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    👥 Users
                </button>
                {% endif %}
                {% if user_permissions.can_manage_settings %}
                <button hx-get="{{ base_url }}/admin/tabs/general" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=general"
                        data-tab="general"
                        class="admin-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    ⚙️ General
                </button>
                {% endif %}
                {% if user_permissions.can_manage_settings %}
                <button hx-get="{{ base_url }}/admin/tabs/media-servers" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=media-servers"
                        data-tab="media-servers"
                        class="admin-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    🖥️ Media Servers
                </button>
                <button hx-get="{{ base_url }}/admin/tabs/services" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=services"
                        data-tab="services"
                        class="admin-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    🔧 Services
                </button>
                {% endif %}
                {% if user_permissions.can_library_sync %}
                <button hx-get="{{ base_url }}/admin/tabs/jobs" 
                        hx-target="#admin-tab-content" 
                        hx-trigger="click"
                        hx-push-url="{{ base_url }}/admin?tab=jobs"
                        data-tab="jobs"
                        class="admin-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    ⏰ Scheduled Jobs
                </button>
                {% endif %}
            </nav>
        </div>

        <!-- HTMX Tab Content Container -->
        <div id="admin-tab-content">
            <!-- Initial content will be loaded based on URL parameter -->
            <div class="flex justify-center py-12">
                <div class="animate-spin w-6 h-6 border-2 border-orange-500 border-t-transparent rounded-full"></div>
            </div>
        </div>

        <!-- Settings Feedback -->
        <div id="settings-feedback" class="mt-6"></div>
    </div>
</div>

<script>
// HTMX tab switching logic with URL state management
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tab from URL parameter
    initializeTabFromURL();
    
    // Handle browser back/forward
    window.addEventListener('popstate', function(event) {
        initializeTabFromURL();
    });
    
    // Handle tab button clicks and update active state
    document.addEventListener('htmx:beforeRequest', function(event) {
        // Check if this is a tab request
        if (event.target.classList.contains('admin-tab-btn')) {
            // Clear any notifications when switching tabs
            clearNotificationParams();
            hideNotificationMessages();
            clearSettingsFeedback();
            
            // Update tab styling based on data-tab attribute
            const targetTab = event.target.getAttribute('data-tab');
            updateActiveTab(targetTab);
        }
    });
});

function initializeTabFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab') || 'overview';
    
    // Update active tab styling
    updateActiveTab(tab);
    
    // Load the tab content
    const baseUrl = '{{ base_url }}';
    const tabUrl = `${baseUrl}/admin/tabs/${tab}`;
    
    // Use HTMX to load the tab content
    htmx.ajax('GET', tabUrl, '#admin-tab-content');
}

function updateActiveTab(activeTab) {
    // Update tab styling
    document.querySelectorAll('.admin-tab-btn').forEach(button => {
        const tabName = button.getAttribute('data-tab');
        if (tabName === activeTab) {
            button.classList.remove('border-transparent', 'text-gray-500');
            button.classList.add('border-primary-500', 'text-primary-600');
        } else {
            button.classList.remove('border-primary-500', 'text-primary-600');
            button.classList.add('border-transparent', 'text-gray-500');
        }
    });
}

function clearNotificationParams() {
    if (window.location.search) {
        const url = new URL(window.location);
        url.searchParams.delete('success');
        url.searchParams.delete('error');
        window.history.replaceState({}, '', url.pathname + url.search);
    }
}

function hideNotificationMessages() {
    const successMessage = document.getElementById('admin-success-message');
    const errorMessage = document.getElementById('admin-error-message');
    
    if (successMessage) {
        successMessage.style.display = 'none';
    }
    if (errorMessage) {
        errorMessage.style.display = 'none';
    }
}

function clearSettingsFeedback() {
    const feedbackDiv = document.getElementById('settings-feedback');
    if (feedbackDiv) {
        feedbackDiv.innerHTML = '';
        feedbackDiv.style.display = 'none';
    }
}

function autoHideNotifications() {
    // Auto-hide notifications after 5 seconds
    setTimeout(() => {
        hideNotificationMessages();
        clearNotificationParams();
        clearSettingsFeedback();
    }, 5000);
}

function autoHideSettingsFeedback() {
    // Auto-hide settings feedback after 5 seconds
    setTimeout(() => {
        clearSettingsFeedback();
    }, 5000);
}



async function testConnections() {
    try {
        showToast('Testing connections...', 'info');
        
        const response = await fetch('{{ base_url }}/admin/settings/test-connections', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            const results = result.results;
            let message = 'Connection test results:\n';
            for (const [service, status] of Object.entries(results)) {
                message += `${service}: ${status ? '✅' : '❌'}\n`;
            }
            showToast(message, results.all_connected ? 'success' : 'warning');
        } else {
            showToast('Failed to test connections', 'error');
        }
    } catch (error) {
        showToast('Error testing connections: ' + error.message, 'error');
    }
}

function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-600' :
        type === 'error' ? 'bg-red-600' :
        type === 'warning' ? 'bg-yellow-600' :
        'bg-blue-600'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Initialize on page load
// Test user form functions
function showCreateTestUser() {
    document.getElementById('create-test-user-form').classList.remove('hidden');
}

function hideCreateTestUser() {
    document.getElementById('create-test-user-form').classList.add('hidden');
    document.getElementById('test-username').value = '';
    document.getElementById('test-is-admin').checked = false;
}

// Local user form functions
function showCreateLocalUser() {
    document.getElementById('create-local-user-form').classList.remove('hidden');
}

function hideCreateLocalUser() {
    document.getElementById('create-local-user-form').classList.add('hidden');
    document.getElementById('local-user-form').reset();
    document.getElementById('local-user-feedback').classList.add('hidden');
}

// Handle local user form submission
document.addEventListener('DOMContentLoaded', function() {
    const localUserForm = document.getElementById('local-user-form');
    if (localUserForm) {
        localUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const userData = {
                username: formData.get('username'),
                full_name: formData.get('full_name'),
                email: formData.get('email'),
                password: formData.get('password'),
                is_admin: formData.get('is_admin') === 'on'
            };
            
            try {
                const response = await fetch('{{ base_url }}/admin/users/create-local', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                const feedbackDiv = document.getElementById('local-user-feedback');
                
                if (response.ok) {
                    feedbackDiv.innerHTML = `
                        <div class="p-3 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-green-700 text-sm">${result.message}</p>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                    
                    // Reset form and refresh users list
                    this.reset();
                    htmx.ajax('GET', '{{ base_url }}/admin/users/list', '#users-list');
                    
                    // Hide form after 3 seconds
                    setTimeout(() => {
                        hideCreateLocalUser();
                    }, 3000);
                } else {
                    feedbackDiv.innerHTML = `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                            <p class="text-red-700 text-sm">${result.detail || 'Failed to create user'}</p>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error creating local user:', error);
                const feedbackDiv = document.getElementById('local-user-feedback');
                feedbackDiv.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                        <p class="text-red-700 text-sm">Network error. Please try again.</p>
                    </div>
                `;
                feedbackDiv.classList.remove('hidden');
            }
        });
    }
});

// Clear authentication issues
function clearAuth() {
    if (confirm('This will clear all authentication cookies and redirect to login. Continue?')) {
        // Clear all authentication-related cookies
        document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
        document.cookie = "plex_token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
        
        // Clear localStorage
        localStorage.removeItem('access_token');
        localStorage.removeItem('plex_token');
        
        // Redirect to logout which will clear server-side cookies too
        window.location.href = '{{ base_url }}/logout';
    }
}

function handleGeneralSettingsResponse(event) {
    // Check if the response was successful by looking for the success message
    const responseText = event.detail.xhr.responseText;
    if (responseText && responseText.includes('General settings updated successfully')) {
        // Extract the new theme from the form
        const themeSelect = document.getElementById('site_theme');
        if (themeSelect) {
            const newTheme = themeSelect.value;
            applyThemeImmediately(newTheme);
            showToast('Settings saved! Theme applied immediately.', 'success');
        }
        // Auto-hide the success message
        autoHideSettingsFeedback();
    }
}

function applyThemeImmediately(theme) {
    const body = document.body;
    
    // Remove all existing theme classes
    body.classList.remove('theme-dark', 'theme-blue', 'theme-green', 'theme-purple');
    
    // Apply new theme class if not default
    if (theme && theme !== 'default') {
        body.classList.add('theme-' + theme);
    }
    
    console.log('Applied theme:', theme);
}

document.addEventListener('DOMContentLoaded', function() {
    showTab('overview');
    
    // Auto-hide any initial notifications after 5 seconds
    autoHideNotifications();
    
    // Set up global HTMX event listeners for auto-refresh
    setupGlobalHTMXHandlers();
});

function setupGlobalHTMXHandlers() {
    // Simplified HTMX handling - let HTMX do the heavy lifting
    console.log('🚀 Admin HTMX handlers set up');
    
    // Set up permissions button handling for dynamically loaded content
    document.body.addEventListener('click', function(event) {
        console.log('🖱️ Click event fired on:', event.target, 'Classes:', event.target.className);
        
        // Check if clicked element or parent has permissions-btn class
        let target = event.target;
        while (target && target !== document.body) {
            if (target.classList && target.classList.contains('permissions-btn')) {
                console.log('🎯 Permissions button found!');
                
                // CRITICAL: Prevent all default behavior immediately
                event.preventDefault();
                event.stopPropagation();
                
                const userId = target.getAttribute('data-user-id');
                console.log('👤 User ID:', userId);
                
                if (userId) {
                    // Call our handler and prevent any further event propagation
                    handlePermissionsClick(userId);
                    return false;
                }
                return false;
            }
            target = target.parentNode;
        }
    });
}

// Permissions modal functions
function showPermissionsModal() {
    const modal = document.getElementById('permissions-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hidePermissionsModal() {
    const modal = document.getElementById('permissions-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Handle permissions button clicks
function handlePermissionsClick(userId) {
    console.log('🚀 handlePermissionsClick called with userId:', userId);
    
    // Prevent any default behavior
    event.preventDefault();
    event.stopPropagation();
    
    const url = `{{ base_url }}/admin/users/${userId}/permissions`;
    console.log('🔍 Fetching from URL:', url);
    
    fetch(url, {
        headers: {
            'HX-Request': 'true'
        }
    })
    .then(response => {
        console.log('✅ Response status:', response.status);
        return response.text();
    })
    .then(html => {
        console.log('📄 Received HTML:', html.length, 'characters');
        const content = document.getElementById('user-permissions-content');
        if (content) {
            content.innerHTML = html;
            console.log('💾 Content updated, showing modal');
            showPermissionsModal();
        } else {
            console.error('❌ Could not find user-permissions-content element');
        }
    })
    .catch(error => {
        console.error('💥 Error loading permissions:', error);
    });
    
    return false; // Prevent any navigation
}

// Standalone permissions modal opener - bypasses all HTMX
function openPermissionsModal(userId) {
    console.log('🚀 openPermissionsModal called with userId:', userId);
    
    const url = `{{ base_url }}/admin/users/${userId}/permissions`;
    console.log('🔍 Fetching from URL:', url);
    
    // Use plain fetch with no HTMX
    fetch(url, {
        method: 'GET',
        headers: {
            'HX-Request': 'true',
            'Accept': 'text/html'
        }
    })
    .then(response => {
        console.log('✅ Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('📄 Received HTML:', html.length, 'characters');
        const content = document.getElementById('user-permissions-content');
        if (content) {
            content.innerHTML = html;
            console.log('💾 Content updated, showing modal');
            
            // Force show the modal
            const modal = document.getElementById('permissions-modal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('✅ Modal displayed');
            } else {
                console.error('❌ Modal element not found');
            }
        } else {
            console.error('❌ Could not find user-permissions-content element');
        }
    })
    .catch(error => {
        console.error('💥 Error loading permissions:', error);
        alert('Error loading permissions: ' + error.message);
    });
}

// Handle permissions save - moved here so it's always available
function handlePermissionsSave(userId) {
    console.log('💾 handlePermissionsSave called with userId:', userId);
    
    const form = document.getElementById('permissions-form');
    if (!form) {
        console.error('❌ Form not found');
        return;
    }
    
    const formData = new FormData(form);
    
    // Show loading
    const submitBtn = document.getElementById('save-permissions-btn');
    if (!submitBtn) {
        console.error('❌ Save button not found');
        return;
    }
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;
    
    // Convert FormData to regular object for JSON
    const data = {};
    
    // Handle role_id and max_requests
    data.role_id = formData.get('role_id') ? parseInt(formData.get('role_id')) : null;
    data.max_requests = formData.get('max_requests') ? parseInt(formData.get('max_requests')) : null;
    
    // Handle checkboxes explicitly (send true/false to override role permissions)
    data.auto_approve = formData.has('auto_approve');
    data.can_request_movies = formData.has('can_request_movies');
    data.can_request_tv = formData.has('can_request_tv');
    data.can_view_other_users_requests = formData.has('can_view_other_users_requests');
    data.can_see_requester_username = formData.has('can_see_requester_username');
    
    console.log('📋 Form data to send:', data);
    
    fetch(`{{ base_url }}/admin/users/${userId}/permissions/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log('✅ Save response:', result);
        if (result.success) {
            // Show success message
            const feedback = document.getElementById('permissions-feedback');
            if (feedback) {
                feedback.className = 'p-4 bg-green-50 border border-green-200 rounded-md';
                feedback.innerHTML = '<p class="text-green-800 font-medium">✓ ' + result.message + '</p>';
                feedback.classList.remove('hidden');
                
                // Auto-dismiss modal after 2 seconds
                setTimeout(() => {
                    hidePermissionsModal();
                }, 2000);
                
                // Refresh the users list to show updated roles
                const usersList = document.getElementById('users-list');
                if (usersList && typeof htmx !== 'undefined') {
                    console.log('🔄 Refreshing users list');
                    htmx.ajax('GET', '{{ base_url }}/admin/users/list', '#users-list');
                }
            }
        } else {
            // Show error message
            const feedback = document.getElementById('permissions-feedback');
            if (feedback) {
                feedback.className = 'p-4 bg-red-50 border border-red-200 rounded-md';
                feedback.innerHTML = '<p class="text-red-800 font-medium">✗ ' + (result.message || 'Error saving permissions') + '</p>';
                feedback.classList.remove('hidden');
            }
        }
    })
    .catch(error => {
        console.error('💥 Error saving permissions:', error);
        const feedback = document.getElementById('permissions-feedback');
        if (feedback) {
            feedback.className = 'p-4 bg-red-50 border border-red-200 rounded-md';
            feedback.innerHTML = '<p class="text-red-800 font-medium">✗ Error saving permissions</p>';
            feedback.classList.remove('hidden');
        }
    })
    .finally(() => {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Global function to save permissions modal
function savePermissions(userId) {
    console.log('🔍 savePermissions() called for user:', userId);
    
    const form = document.getElementById('permissions-form');
    const saveBtn = document.getElementById('save-btn');
    const saveText = document.getElementById('save-text');
    
    console.log('🔍 Form element found:', form);
    console.log('🔍 Save button found:', saveBtn);
    
    if (!form) {
        console.error('🔍 Form not found!');
        console.log('🔍 Available elements with permissions-form id:', document.getElementById('permissions-form'));
        console.log('🔍 All forms on page:', document.forms);
        return;
    }
    
    // Show loading state
    saveBtn.disabled = true;
    saveText.textContent = 'Saving...';
    
    // Get form data
    const formData = new FormData(form);
    const rawData = Object.fromEntries(formData);
    
    console.log('🔍 Raw form data:', rawData);
    
    // Debug specific checkbox states
    const moviesCheckbox = document.getElementById('can_request_movies');
    const tvCheckbox = document.getElementById('can_request_tv');
    const fourKCheckbox = document.getElementById('can_request_4k');
    
    console.log('🔍 Checkbox elements found:');
    console.log('🔍   Movies checkbox:', moviesCheckbox, 'checked:', moviesCheckbox?.checked);
    console.log('🔍   TV checkbox:', tvCheckbox, 'checked:', tvCheckbox?.checked);
    console.log('🔍   4K checkbox:', fourKCheckbox, 'checked:', fourKCheckbox?.checked);
    
    // Convert form data to proper JSON format for UserPermissionsUpdate model
    const jsonData = {
        role_id: rawData.role_id ? parseInt(rawData.role_id) : null,
        max_requests: rawData.max_requests ? parseInt(rawData.max_requests) : null,
        auto_approve: rawData.auto_approve === 'on',
        // For permission checkboxes: send the desired effective permission
        // Backend will calculate the correct override (true/false/null) based on role
        // Note: checkboxes with value="true" send 'true' when checked, not 'on'
        can_request_movies: rawData.can_request_movies === 'true',
        can_request_tv: rawData.can_request_tv === 'true',
        can_view_other_users_requests: rawData.can_view_other_users_requests === 'true',
        can_see_requester_username: rawData.can_see_requester_username === 'true'
    };
    
    console.log('🔍 Converted JSON data:', jsonData);
    
    // Prevent any default form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Make request with form data to the limits endpoint (which handles instances)
    fetch('{{ base_url }}/admin/users/' + userId + '/permissions/limits', {
        method: 'POST',
        headers: {
            'X-Skip-Global-Toast': 'true'
        },
        body: formData,  // Send form data directly instead of JSON
        credentials: 'include'
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }).then(data => {
        console.log('🔍 Request completed successfully:', data);
        // Close modal using existing function
        hidePermissionsModal();
        
        // Refresh the users list to show updated permissions/roles
        const usersList = document.getElementById('users-list');
        if (usersList && typeof htmx !== 'undefined') {
            console.log('🔍 Refreshing users list');
            htmx.ajax('GET', '{{ base_url }}/admin/users/list', '#users-list');
        }
        
        // Show success toast - use our own simple toast to avoid showToast issues
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
        toast.textContent = 'Permissions saved successfully!';
        if (document.body) {
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        } else {
            console.error('🔍 document.body not available for toast');
        }
    }).catch((error) => {
        console.error('🔍 Request failed:', error);
        // Reset button state
        saveBtn.disabled = false;
        saveText.textContent = 'Save All Changes';
        
        // Show error toast with more specific message
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
        toast.textContent = error.message.includes('422') 
            ? 'Invalid data format - check form values!' 
            : 'Failed to save permissions!';
        if (document.body) {
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        } else {
            console.error('🔍 document.body not available for error toast');
        }
    });
}

// Also attach to window for global access
window.savePermissions = savePermissions;

// Debug: log that the function is defined
console.log('🔍 savePermissions function defined in dashboard:', typeof savePermissions);
console.log('🔍 window.savePermissions defined in dashboard:', typeof window.savePermissions);

// Library Preferences Functions
async function loadLibraryPreferences() {
    try {
        console.log('🔄 Loading library preferences...');
        const response = await fetch('{{ base_url }}/admin/library/preferences', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });
        const data = await response.json();
        
        if (response.ok) {
            console.log('✅ Library preferences loaded successfully:', data);
            renderLibraryPreferences(data.libraries, data.selected_libraries);
        } else {
            console.error('❌ Error response:', response.status, data);
            let errorMessage = data.detail || 'Unknown error';
            
            // Provide more helpful error messages
            if (response.status === 500 && errorMessage.includes('Plex')) {
                errorMessage = 'Plex connection failed. Please configure your Plex server settings first.';
            } else if (response.status === 500 && errorMessage.includes('database')) {
                errorMessage = 'Database connection error. Please contact your administrator.';
            }
            
            document.getElementById('library-preferences-content').innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Library Sync Unavailable</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>${errorMessage}</p>
                                ${response.status === 500 && errorMessage.includes('Plex') ? 
                                    '<p class="mt-2"><strong>Next steps:</strong></p><ol class="list-decimal list-inside mt-1"><li>Configure your Plex Server URL and Token above</li><li>Save the settings</li><li>Library preferences will then load automatically</li></ol>' 
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('❌ Network error loading library preferences:', error);
        document.getElementById('library-preferences-content').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Connection Error</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>Unable to connect to the server. Please check your connection and try again.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

function renderLibraryPreferences(libraries, selectedLibraries) {
    const container = document.getElementById('library-preferences-content');
    
    if (!libraries || libraries.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-gray-500 text-sm">
                <p>No Plex libraries found. Please check your Plex connection.</p>
            </div>
        `;
        return;
    }
    
    // Group libraries by type for more compact display
    const movieLibraries = libraries.filter(lib => lib.type === 'movie');
    const tvLibraries = libraries.filter(lib => lib.type === 'show');
    
    const createLibraryRow = (library) => {
        const isSelected = selectedLibraries.includes(library.title);
        const typeIcon = library.type === 'movie' ? '🎬' : '📺';
        
        return `
            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                <input 
                    type="checkbox" 
                    id="library-${library.key}" 
                    name="selected_libraries" 
                    value="${library.title}"
                    ${isSelected ? 'checked' : ''}
                    class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
                />
                <span class="text-sm">${typeIcon}</span>
                <span class="text-sm text-gray-900 flex-1">${library.title}</span>
            </label>
        `;
    };
    
    let sectionsHtml = '';
    
    if (movieLibraries.length > 0) {
        sectionsHtml += `
            <div class="mb-3">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Movie Libraries</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
                    ${movieLibraries.map(createLibraryRow).join('')}
                </div>
            </div>
        `;
    }
    
    if (tvLibraries.length > 0) {
        sectionsHtml += `
            <div class="mb-3">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">TV Libraries</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
                    ${tvLibraries.map(createLibraryRow).join('')}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="space-y-1">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-600">${libraries.length} libraries available</span>
                <div class="space-x-2">
                    <button onclick="selectAllLibraries()" class="text-xs text-orange-600 hover:text-orange-500">All</button>
                    <button onclick="selectNoneLibraries()" class="text-xs text-gray-600 hover:text-gray-500">None</button>
                </div>
            </div>
            ${sectionsHtml}
        </div>
    `;
}

function selectAllLibraries() {
    const checkboxes = document.querySelectorAll('input[name="selected_libraries"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function selectNoneLibraries() {
    const checkboxes = document.querySelectorAll('input[name="selected_libraries"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

async function saveLibraryPreferences() {
    const checkboxes = document.querySelectorAll('input[name="selected_libraries"]:checked');
    const selectedLibraries = Array.from(checkboxes).map(cb => cb.value);
    
    try {
        const response = await fetch('{{ base_url }}/admin/library/preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                selected_libraries: selectedLibraries
            })
        });
        
        const result = await response.json();
        const feedbackDiv = document.getElementById('library-preferences-feedback');
        
        if (response.ok) {
            feedbackDiv.innerHTML = `
                <div class="p-3 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-green-700 text-sm">${result.message}</p>
                </div>
            `;
            feedbackDiv.classList.remove('hidden');
            
            // Hide feedback after 5 seconds
            setTimeout(() => {
                feedbackDiv.classList.add('hidden');
            }, 5000);
        } else {
            feedbackDiv.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                    <p class="text-red-700 text-sm">${result.detail || 'Failed to save preferences'}</p>
                </div>
            `;
            feedbackDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error saving library preferences:', error);
        const feedbackDiv = document.getElementById('library-preferences-feedback');
        feedbackDiv.innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                <p class="text-red-700 text-sm">Network error. Please try again.</p>
            </div>
        `;
        feedbackDiv.classList.remove('hidden');
    }
}

// Toggle library preferences display
function toggleLibraryPreferences() {
    const container = document.getElementById('library-preferences-container');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        toggleText.textContent = 'Hide';
        toggleIcon.classList.add('rotate-180');
        
        // Load preferences when first showing
        if (!container.hasAttribute('data-loaded')) {
            loadLibraryPreferences();
            container.setAttribute('data-loaded', 'true');
        }
    } else {
        container.classList.add('hidden');
        toggleText.textContent = 'Show';
        toggleIcon.classList.remove('rotate-180');
    }
}

// Load library preferences when media servers tab is shown
function handleTabSwitch(tabName) {
    if (tabName === 'media-servers') {
        // Don't auto-load preferences anymore - wait for user to click show
        // Just ensure the toggle is in the correct state
        const container = document.getElementById('library-preferences-container');
        if (container && !container.classList.contains('hidden')) {
            setTimeout(() => {
                loadLibraryPreferences();
            }, 100);
        }
    }
}

// Override the showTab function to handle library loading
const originalShowTab = showTab;
showTab = function(tabName) {
    originalShowTab(tabName);
    handleTabSwitch(tabName);
};
</script>

<style>
.tab-button {
    transition: all 0.2s ease;
}

.tab-button:hover {
    transform: translateY(-1px);
}

.tab-content {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- Permissions Modal -->
<div id="permissions-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hidePermissionsModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900">User Permissions</h2>
            <button 
                type="button" 
                class="text-gray-400 hover:text-gray-600"
                onclick="hidePermissionsModal()"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="user-permissions-content" class="p-6">
            <!-- HTMX will load content here -->
        </div>
    </div>
</div>

{% endblock %}