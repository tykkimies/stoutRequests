<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Stout Requests{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- HTMX HTTPS Fix -->
    <script>
        // Fix HTMX mixed content issues by ensuring all HTMX requests use the current protocol
        document.addEventListener('htmx:configRequest', function(evt) {
            // Get the current URL and check if it starts with a relative path
            let url = evt.detail.path;
            
            // Get the base URL from the current page's configuration
            const baseUrl = '{{ base_url }}';
            
            
            // If it's a relative URL starting with our base_url path, 
            // convert it to an absolute URL with current protocol
            if (url && baseUrl && url.startsWith(baseUrl)) {
                const newUrl = window.location.origin + url;
                evt.detail.path = newUrl;
            }
            // Also handle any URL that starts with / but not with base_url
            else if (url && url.startsWith('/') && !url.startsWith('http')) {
                const newUrl = window.location.origin + url;
                evt.detail.path = newUrl;
            }
        });
    </script>
    
    <!-- Custom styles -->
    <style>
        .bg-gradient-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Theme Variables */
        :root {
            --primary-50: 255, 247, 237;
            --primary-100: 255, 237, 213;
            --primary-200: 254, 215, 170;
            --primary-300: 253, 186, 116;
            --primary-400: 251, 146, 60;
            --primary-500: 249, 115, 22;
            --primary-600: 234, 88, 12;
            --primary-700: 194, 65, 12;
            --primary-800: 154, 52, 18;
            --primary-900: 124, 45, 18;
        }
        
        /* Blue Theme */
        body.theme-blue {
            --primary-50: 239, 246, 255;
            --primary-100: 219, 234, 254;
            --primary-200: 191, 219, 254;
            --primary-300: 147, 197, 253;
            --primary-400: 96, 165, 250;
            --primary-500: 59, 130, 246;
            --primary-600: 37, 99, 235;
            --primary-700: 29, 78, 216;
            --primary-800: 30, 64, 175;
            --primary-900: 30, 58, 138;
        }
        
        /* Green Theme */
        body.theme-green {
            --primary-50: 240, 253, 244;
            --primary-100: 220, 252, 231;
            --primary-200: 187, 247, 208;
            --primary-300: 134, 239, 172;
            --primary-400: 74, 222, 128;
            --primary-500: 34, 197, 94;
            --primary-600: 22, 163, 74;
            --primary-700: 21, 128, 61;
            --primary-800: 22, 101, 52;
            --primary-900: 20, 83, 45;
        }
        
        /* Purple Theme */
        body.theme-purple {
            --primary-50: 250, 245, 255;
            --primary-100: 243, 232, 255;
            --primary-200: 233, 213, 255;
            --primary-300: 196, 181, 253;
            --primary-400: 147, 125, 250;
            --primary-500: 99, 102, 241;
            --primary-600: 79, 70, 229;
            --primary-700: 67, 56, 202;
            --primary-800: 55, 48, 163;
            --primary-900: 49, 46, 129;
        }
        
        /* Dark Theme */
        body.theme-dark {
            background-color: #1f2937;
            color: #f9fafb;
            --primary-50: 55, 65, 81;
            --primary-100: 75, 85, 99;
            --primary-200: 107, 114, 128;
            --primary-300: 156, 163, 175;
            --primary-400: 209, 213, 219;
            --primary-500: 229, 231, 235;
            --primary-600: 243, 244, 246;
            --primary-700: 249, 250, 251;
            --primary-800: 255, 255, 255;
            --primary-900: 255, 255, 255;
        }
        
        body.theme-dark .bg-white { background-color: #374151 !important; }
        body.theme-dark .bg-gray-50 { background-color: #4b5563 !important; }
        body.theme-dark .bg-gray-100 { background-color: #1f2937 !important; }
        body.theme-dark .text-gray-900 { color: #f9fafb !important; }
        body.theme-dark .text-gray-800 { color: #e5e7eb !important; }
        body.theme-dark .text-gray-700 { color: #d1d5db !important; }
        body.theme-dark .text-gray-600 { color: #9ca3af !important; }
        body.theme-dark .text-gray-500 { color: #6b7280 !important; }
        body.theme-dark .border-gray-200 { border-color: #4b5563 !important; }
        body.theme-dark .border-gray-300 { border-color: #6b7280 !important; }
        
        /* Dynamic Primary Colors */
        .bg-primary-500 { background-color: rgb(var(--primary-500)); }
        .bg-primary-600 { background-color: rgb(var(--primary-600)); }
        .bg-primary-700 { background-color: rgb(var(--primary-700)); }
        .text-primary-600 { color: rgb(var(--primary-600)); }
        .text-primary-700 { color: rgb(var(--primary-700)); }
        .border-primary-500 { border-color: rgb(var(--primary-500)); }
        .ring-primary-500 { --tw-ring-color: rgb(var(--primary-500)); }
        .focus\:ring-primary-500:focus { --tw-ring-color: rgb(var(--primary-500)); }
        .focus\:border-primary-500:focus { border-color: rgb(var(--primary-500)); }
        
        /* Animations for success/error messages */
        @keyframes fadeOut {
            0% { opacity: 1; }
            75% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen {% if current_user %}flex flex-col{% endif %} {% if site_theme and site_theme != 'default' %}theme-{{ site_theme }}{% endif %}">
    <!-- Navigation -->
    <nav class="bg-gradient-dark shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-white text-shadow">üç∫ Stout Requests</h1>
                    </div>
                    {% if current_user %}
                    <!-- Desktop Navigation -->
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{{ base_url }}/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Search</a>
                            <a href="{{ base_url }}/requests/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Requests</a>
                            {% if user_permissions.can_manage_settings or user_permissions.can_manage_users or user_permissions.can_approve_requests or user_permissions.can_library_sync %}
                            <a href="{{ base_url }}/admin/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">‚öôÔ∏è Admin</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center">
                    {% if current_user %}
                    <!-- Desktop User Info -->
                    <div class="hidden md:flex items-center space-x-4">
                        <span class="text-gray-300 text-sm">Welcome, {{ current_user.full_name or current_user.username }}</span>
                        {% if user_is_admin %}
                        <span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">Admin</span>
                        {% endif %}
                        {% if current_user.plex_id and current_user.plex_id < 0 %}
                        <span class="bg-purple-600 text-white px-2 py-1 rounded text-xs">Test User</span>
                        <a href="{{ base_url }}/admin" class="bg-primary-600 hover:bg-primary-700 text-white px-2 py-1 rounded text-xs">Return to Admin</a>
                        {% endif %}
                        <a href="{{ base_url }}/logout" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Logout</a>
                    </div>
                    
                    <!-- Mobile Hamburger Menu Button -->
                    <div class="md:hidden">
                        <button 
                            id="mobile-nav-toggle"
                            onclick="toggleMobileNavigation()"
                            class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md transition-colors"
                            aria-label="Toggle navigation menu"
                            aria-expanded="false"
                        >
                            <svg id="nav-hamburger-icon" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                            <svg id="nav-close-icon" class="w-5 h-5 hidden transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    {% else %}
                    <a href="{{ base_url }}/login" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Login with Plex
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% if current_user %}
            <!-- Mobile Navigation Menu -->
            <div 
                id="mobile-nav-menu"
                class="md:hidden hidden bg-gray-800 border-t border-gray-700 pb-3 pt-2"
            >
                <div class="px-2 space-y-1">
                    <a href="{{ base_url }}/" class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-2 rounded-md text-base font-medium">Search</a>
                    <a href="{{ base_url }}/requests/" class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-2 rounded-md text-base font-medium">Requests</a>
                    {% if user_permissions.can_manage_settings or user_permissions.can_manage_users or user_permissions.can_approve_requests or user_permissions.can_library_sync %}
                    <a href="{{ base_url }}/admin/" class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-2 rounded-md text-base font-medium">‚öôÔ∏è Admin</a>
                    {% endif %}
                </div>
                
                <!-- Mobile User Info -->
                <div class="pt-4 pb-3 border-t border-gray-700 mt-3">
                    <div class="px-3 text-gray-300 text-sm mb-2">Welcome, {{ current_user.full_name or current_user.username }}</div>
                    <div class="px-3 flex flex-wrap gap-2 mb-3">
                        {% if user_is_admin %}
                        <span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">Admin</span>
                        {% endif %}
                        {% if current_user.plex_id and current_user.plex_id < 0 %}
                        <span class="bg-purple-600 text-white px-2 py-1 rounded text-xs">Test User</span>
                        <a href="{{ base_url }}/admin" class="bg-primary-600 hover:bg-primary-700 text-white px-2 py-1 rounded text-xs">Return to Admin</a>
                        {% endif %}
                    </div>
                    <div class="px-2">
                        <a href="{{ base_url }}/logout" class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-2 rounded-md text-base font-medium">Logout</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Main content -->
    <main class="{% if current_user %}flex-1 overflow-hidden{% else %}max-w-7xl mx-auto py-6 sm:px-6 lg:px-8{% endif %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Toast notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Simple toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 max-w-sm`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Sync token from cookie to localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get token from cookie
            const cookieToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('access_token='))
                ?.split('=')[1];
            
            if (cookieToken && !localStorage.getItem('access_token')) {
                localStorage.setItem('access_token', cookieToken);
            }
        });

        // Add Authorization header to all HTMX requests
        document.addEventListener('htmx:configRequest', function(event) {
            let token = localStorage.getItem('access_token');
            
            // Fallback to cookie if localStorage is empty
            if (!token) {
                token = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('access_token='))
                    ?.split('=')[1];
                
                if (token) {
                    localStorage.setItem('access_token', token);
                }
            }
            
            if (token) {
                event.detail.headers['Authorization'] = 'Bearer ' + token;
            }
        });

        // HTMX event listeners
        document.addEventListener('htmx:responseError', function(event) {
            showToast('An error occurred. Please try again.', 'error');
        });
        
        document.addEventListener('htmx:sendError', function(event) {
            showToast('Network error. Please check your connection.', 'error');
        });
        
        // Enhanced HTMX event handling for better UX
        document.addEventListener('htmx:afterRequest', function(event) {
            const response = event.detail.xhr;
            const headers = event.detail.requestConfig.headers || {};
            
            // Skip if request has X-Skip-Global-Toast header
            if (headers['X-Skip-Global-Toast'] === 'true') {
                return;
            }
            
            // Only show success toast for POST/PUT/DELETE operations (not GET requests)
            const method = event.detail.requestConfig.verb.toLowerCase();
            if (response.status === 200 && 
                ['post', 'put', 'delete'].includes(method) && 
                response.responseText.includes('successfully')) {
                showToast('Operation completed successfully!', 'success');
            }
        });

        // Global state for category expansion
        let isExpanded = false;
        let expandedHistoryState = null;

        // Category expansion function - available globally
        window.expandCategoryView = function(type, sort, title) {
            
            // Set expanded state
            isExpanded = true;
            
            // Create a history entry ONLY when expanding (not when going back)
            if (!expandedHistoryState) {
                expandedHistoryState = { expanded: true, type: type, sort: sort, title: title };
                const baseUrl = '{{ base_url }}';
                
                // Handle different URL patterns for different category types
                let historyUrl;
                if (type.startsWith('custom_')) {
                    // For custom categories, use a more descriptive URL
                    historyUrl = baseUrl + '/discover/category/' + type + '/' + sort;
                } else {
                    // For other categories, use the standard pattern
                    historyUrl = baseUrl + '/discover/' + type + '/' + sort;
                }
                
                history.pushState(expandedHistoryState, title, historyUrl);
            }
            
            // For custom categories, we need to load the expanded view first to get the correct media type
            // The backend will handle loading the saved filters and using the correct media type
            const baseUrl = '{{ base_url }}';
            
            // Handle different category types with appropriate parameters
            if (type === 'plex' || type === 'requests' || type === 'recommendations') {
                // Database categories: default to movie media type with db_category parameters
                let mediaType = 'movie';
                let expandUrl = baseUrl + '/discover/category/expanded?type=' + mediaType + '&sort=' + sort + '&limit=40&page=1';
                expandUrl += '&db_category_type=' + type + '&db_category_sort=' + sort;
                let filterUrl = baseUrl + '/discover/filters?media_type=' + mediaType;
                filterUrl += '&db_category_type=' + type + '&db_category_sort=' + sort;
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            } else if (type.startsWith('custom_')) {
                // Custom categories: Let the backend determine the correct media type from saved filters
                let customCategoryId = type.replace('custom_', '');
                let expandUrl = baseUrl + '/discover/category/expanded?sort=' + sort + '&limit=40&page=1';
                expandUrl += '&custom_category_id=' + customCategoryId;
                let filterUrl = baseUrl + '/discover/filters?custom_category_id=' + customCategoryId;
                
                console.log('üéØ Loading custom category:', customCategoryId);
                console.log('üéØ Expand URL:', expandUrl);
                console.log('üéØ Filter URL:', filterUrl);
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            } else {
                // Content source categories (trending, popular, top_rated, upcoming)
                // For these, type is actually the media_type (movie/tv)
                let expandUrl = baseUrl + '/discover/category/expanded?type=' + type + '&sort=' + sort + '&limit=40&page=1';
                expandUrl += '&content_sources=' + sort;
                let filterUrl = baseUrl + '/discover/filters?media_type=' + type;
                filterUrl += '&content_sources=' + sort;
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            }
            
            // Scroll to top
            setTimeout(() => {
                const container = document.getElementById('categories-container');
                if (container) {
                    container.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            }, 100);
        }

        // Back to categories function - available globally
        window.backToCategoriesView = function() {
            
            // Clear expanded state
            isExpanded = false;
            expandedHistoryState = null;
            
            // Update URL to root
            const baseUrl = '{{ base_url }}';
            history.pushState(null, '', baseUrl + '/');
            
            // Load categories view
            htmx.ajax('GET', baseUrl + '/discover/categories', {
                target: '#categories-container', 
                swap: 'innerHTML'
            });
            
            // Reset filter bar
            htmx.ajax('GET', baseUrl + '/discover/filters', {
                target: '#filter-form-container', 
                swap: 'innerHTML'
            });
            
            // Scroll to top
            setTimeout(() => {
                const container = document.getElementById('categories-container');
                if (container) {
                    container.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            }, 100);
        }


        // Browser back button support
        window.addEventListener('popstate', function(event) {
            if (isExpanded) {
                // If we're in expanded view and browser back is pressed, collapse
                backToCategoriesView();
            }
        });

        // Category customization functionality
        let isCustomizeMode = false;

        // Clear any cached category data on page load
        Object.keys(sessionStorage).forEach(key => {
            if (key.startsWith('category-cache-')) {
                sessionStorage.removeItem(key);
            }
        });
        // Clear everything to be sure
        sessionStorage.clear();
        localStorage.clear();
        

        // Global function for category customization
        window.toggleCustomizeMode = function() {
            const button = document.getElementById('reorder-toggle');
            const categoriesContainer = document.getElementById('categories-container');
            
            if (!isCustomizeMode) {
                // Enter customize mode
                isCustomizeMode = true;
                
                if (button) {
                    button.textContent = 'üíæ Save Changes';
                    button.classList.add('bg-orange-100', 'text-orange-700');
                    button.classList.remove('bg-gray-100', 'text-gray-700');
                }
                
                const baseUrl = '{{ base_url }}';
                const url = baseUrl + '/discover/categories/customize-mode';
                
                // Load customize mode interface
                htmx.ajax('GET', url, {
                    target: '#categories-container',
                    swap: 'innerHTML'
                });
            } else {
                // Exit customize mode and save changes
                isCustomizeMode = false;
                
                if (button) {
                    button.textContent = 'üì± Customize';
                    button.classList.remove('bg-orange-100', 'text-orange-700');
                    button.classList.add('bg-gray-100', 'text-gray-700');
                }
                
                // Save the current state and reload normal view
                saveCategoryCustomizations();
            }
        };

        window.saveCategoryCustomizations = function() {
            // Collect all visible category preferences from the customization interface
            const categoryItems = document.querySelectorAll('.customize-category-item');
            
            // Get all available categories to mark hidden ones
            const allCategoryIds = ['recently-added', 'recent-requests', 'trending-movies', 'popular-movies', 'trending-tv', 'popular-tv', 'top-rated-movies', 'upcoming-movies', 'top-rated-tv'];
            const visibleCategoryIds = [];
            const customizations = {};
            
            categoryItems.forEach((item, index) => {
                const categoryId = item.dataset.categoryId;
                const displayOrder = index + 1; // Use position in list as order
                
                visibleCategoryIds.push(categoryId);
                customizations[`${categoryId}_visible`] = 'on';
                customizations[`${categoryId}_order`] = displayOrder.toString();
            });
            
            // Mark categories that are not in the visible list as hidden
            allCategoryIds.forEach(categoryId => {
                if (!visibleCategoryIds.includes(categoryId)) {
                    customizations[`${categoryId}_visible`] = 'off';
                    customizations[`${categoryId}_order`] = '0';
                }
            });
            
            
            // Reset customize mode state immediately
            isCustomizeMode = false;
            const button = document.getElementById('reorder-toggle');
            if (button) {
                button.textContent = 'üì± Customize';
                button.classList.remove('bg-orange-100', 'text-orange-700');
                button.classList.add('bg-gray-100', 'text-gray-700');
            }
            
            // Submit customizations
            const baseUrl = '{{ base_url }}';
            htmx.ajax('POST', baseUrl + '/discover/categories/save-customizations', {
                target: '#categories-container',
                swap: 'innerHTML',
                values: customizations
            }).then(() => {
                // Show success message
                showToast('Categories saved successfully!', 'success');
            }).catch((error) => {
                showToast('Error saving categories. Please try again.', 'error');
                
                // Reset customize mode on error
                isCustomizeMode = true;
                if (button) {
                    button.textContent = 'üíæ Save Changes';
                    button.classList.add('bg-orange-100', 'text-orange-700');
                    button.classList.remove('bg-gray-100', 'text-gray-700');
                }
            });
        };

        window.cancelCustomizeMode = function() {
            const button = document.getElementById('reorder-toggle');
            
            isCustomizeMode = false;
            if (button) {
                button.textContent = 'üì± Customize';
                button.classList.remove('bg-orange-100', 'text-orange-700');
                button.classList.add('bg-gray-100', 'text-gray-700');
            }
            
            // Reload normal categories view
            const baseUrl = '{{ base_url }}';
            htmx.ajax('GET', baseUrl + '/discover/categories', {
                target: '#categories-container',
                swap: 'innerHTML'
            });
        };

        
        // Also add click event listener as backup
        document.addEventListener('DOMContentLoaded', function() {
            const customizeBtn = document.getElementById('reorder-toggle');
            if (customizeBtn) {
                customizeBtn.addEventListener('click', function() {
                    window.toggleCustomizeMode();
                });
            } else {
                // Try again after a delay in case it's loaded by HTMX
                setTimeout(function() {
                    const delayedBtn = document.getElementById('reorder-toggle');
                    if (delayedBtn) {
                        delayedBtn.addEventListener('click', function() {
                            window.toggleCustomizeMode();
                        });
                    }
                }, 1000);
            }
        });

        // Simple and reliable dropdown positioning
        window.toggleDropdownMenu = function(button) {
            const dropdown = button.nextElementSibling;
            const isHidden = dropdown.classList.contains('hidden');
            
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-menu').forEach(function(d) {
                if (d !== dropdown) {
                    d.classList.add('hidden');
                }
            });
            
            if (isHidden) {
                // Move dropdown to body to completely escape all container constraints
                if (dropdown.parentNode !== document.body) {
                    // Store original parent and position for cleanup
                    dropdown._originalParent = dropdown.parentNode;
                    dropdown._originalNextSibling = dropdown.nextSibling;
                    document.body.appendChild(dropdown);
                }
                
                // Show dropdown and position it
                dropdown.classList.remove('hidden');
                
                // Get button position relative to viewport
                const buttonRect = button.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Position dropdown with fixed positioning
                dropdown.style.position = 'fixed';
                dropdown.style.zIndex = '2147483647'; // Maximum z-index
                
                // Set minimum width to match button, but allow it to be wider if needed
                const minWidth = Math.max(buttonRect.width, 160);
                dropdown.style.minWidth = minWidth + 'px';
                
                // Calculate horizontal position (prefer left-aligned with button)
                let leftPos = buttonRect.left;
                
                // If dropdown would go off right edge, adjust position
                if (leftPos + minWidth > viewportWidth - 20) {
                    leftPos = Math.max(20, viewportWidth - minWidth - 20);
                }
                
                dropdown.style.left = leftPos + 'px';
                
                // Calculate vertical position (prefer below button)
                let topPos = buttonRect.bottom + 4;
                
                // If dropdown would go off bottom edge, show above button instead
                const dropdownHeight = dropdown.offsetHeight || 200; // estimate if not measured yet
                if (topPos + dropdownHeight > viewportHeight - 20 && buttonRect.top > dropdownHeight + 20) {
                    topPos = buttonRect.top - dropdownHeight - 4;
                }
                
                dropdown.style.top = Math.max(20, topPos) + 'px';
                
            } else {
                // Hide dropdown and return to original position
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            }
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Check if the click is outside all dropdown triggers and menus
            if (!event.target.closest('button[onclick*="toggleDropdownMenu"]') && 
                !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                    dropdown.classList.add('hidden');
                    
                    // Return dropdown to its original parent if it was moved to body
                    if (dropdown._originalParent && dropdown.parentNode === document.body) {
                        if (dropdown._originalNextSibling) {
                            dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                        } else {
                            dropdown._originalParent.appendChild(dropdown);
                        }
                    }
                });
            }
        });
        
        // Close dropdowns on scroll to prevent positioning issues
        document.addEventListener('scroll', function() {
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
        }, true);
        
        // Global function to close all dropdowns (used by dropdown buttons)
        window.closeAllDropdowns = function() {
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
        };

        // Mobile navigation functionality
        window.toggleMobileNavigation = function() {
            const mobileMenu = document.getElementById('mobile-nav-menu');
            const toggleBtn = document.getElementById('mobile-nav-toggle');
            const hamburgerIcon = document.getElementById('nav-hamburger-icon');
            const closeIcon = document.getElementById('nav-close-icon');
            
            if (mobileMenu && toggleBtn && hamburgerIcon && closeIcon) {
                const isHidden = mobileMenu.classList.contains('hidden');
                
                if (isHidden) {
                    // Show mobile menu
                    mobileMenu.classList.remove('hidden');
                    hamburgerIcon.classList.add('hidden');
                    closeIcon.classList.remove('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'true');
                } else {
                    // Hide mobile menu
                    mobileMenu.classList.add('hidden');
                    hamburgerIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                }
            }
        };

        // Close mobile navigation when window is resized to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) { // md breakpoint
                const mobileMenu = document.getElementById('mobile-nav-menu');
                const toggleBtn = document.getElementById('mobile-nav-toggle');
                const hamburgerIcon = document.getElementById('nav-hamburger-icon');
                const closeIcon = document.getElementById('nav-close-icon');
                
                if (mobileMenu && toggleBtn && hamburgerIcon && closeIcon) {
                    mobileMenu.classList.add('hidden');
                    hamburgerIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });
    </script>
    
    <!-- Enhanced dropdown styling to match site aesthetic -->
    <style>
        /* Force dropdown menus to appear above all other content with beautiful styling */  
        .dropdown-menu {
            position: fixed !important;
            z-index: 2147483647 !important; /* Maximum possible z-index */
            
            /* Enhanced visual styling */
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%) !important;
            border: 1px solid rgba(59, 130, 246, 0.15) !important;
            border-radius: 12px !important;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(255, 255, 255, 0.05) !important;
            
            /* Animation and transitions */
            opacity: 0 !important;
            transform: translateY(-8px) scale(0.95) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            backdrop-filter: blur(8px) !important;
            
            /* Typography */
            font-family: system-ui, -apple-system, sans-serif !important;
        }
        
        /* Show animation for dropdown */
        .dropdown-menu:not(.hidden) {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }
        
        /* Enhanced dropdown button styling within dropdown */
        .dropdown-menu button {
            transition: all 0.15s ease !important;
            border-radius: 8px !important;
            margin: 2px !important;
            font-weight: 500 !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .dropdown-menu button:hover {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
            color: white !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 8px 15px -3px rgba(249, 115, 22, 0.3) !important;
        }
        
        .dropdown-menu button:active {
            transform: translateY(0) !important;
            box-shadow: 0 4px 8px -2px rgba(249, 115, 22, 0.4) !important;
        }
        
        /* Quality tier and category badges in dropdown */
        .dropdown-menu .bg-blue-100 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            color: #1e40af !important;
            font-weight: 600 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(59, 130, 246, 0.2) !important;
        }
        
        .dropdown-menu .bg-gray-100 {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
            color: #374151 !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(107, 114, 128, 0.15) !important;
        }
        
        /* Ensure dropdown triggers have appropriate stacking and enhanced styling */
        button[onclick*="toggleDropdownMenu"] {
            position: relative !important;
            z-index: 10 !important;
            transition: all 0.2s ease !important;
        }
        
        button[onclick*="toggleDropdownMenu"]:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 8px 15px -3px rgba(249, 115, 22, 0.4) !important;
        }
        
        button[onclick*="toggleDropdownMenu"]:active {
            transform: translateY(0) !important;
        }
        
        /* Prevent any overflow hidden from affecting dropdowns */
        .media-card,
        .movie-card-horizontal,
        [data-dropdown-boundary] {
            overflow: visible !important;
        }
        
        /* Ensure containers don't create new stacking contexts that interfere */
        .flex[style*="overflow-x"],  
        .grid {
            contain: layout style !important;
        }
        
        /* Add subtle loading state for dropdown items */
        .dropdown-menu form {
            position: relative !important;
        }
        
        .dropdown-menu form::after {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.1), transparent) !important;
            transform: translateX(-100%) !important;
            transition: transform 0.6s ease !important;
            pointer-events: none !important;
            opacity: 0 !important;
        }
        
        .dropdown-menu form:hover::after {
            transform: translateX(100%) !important;
            opacity: 1 !important;
        }
        
        /* Mobile Navigation Styling */
        #mobile-nav-menu {
            animation: slideDown 0.3s ease-out;
        }
        
        #mobile-nav-menu.hidden {
            animation: slideUp 0.3s ease-in;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* Ensure mobile nav links have proper touch targets */
        #mobile-nav-menu a {
            min-height: 44px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        #mobile-nav-menu a:hover {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            transform: translateX(4px);
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 640px) {
            .dropdown-menu {
                max-width: calc(100vw - 40px) !important;
                left: 20px !important;
                right: 20px !important;
                width: auto !important;
                border-radius: 16px !important;
            }
            
            .dropdown-menu button {
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
        }
        
        /* Dark mode compatibility (if ever implemented) */
        @media (prefers-color-scheme: dark) {
            .dropdown-menu {
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
                border-color: rgba(75, 85, 99, 0.3) !important;
                color: #f9fafb !important;
            }
        }
    </style>
</body>
</html>