<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CuePlex{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- Modern Dark Mode CSS -->
    <link rel="stylesheet" href="{{ base_url }}/static/css/dark-mode-modern.css">
    
    <!-- HTMX HTTPS Fix and Authentication -->
    <script>
        // Consolidated HTMX configuration for authentication, URL handling, and credentials
        document.addEventListener('htmx:configRequest', function(evt) {
            // Get the current URL and check if it starts with a relative path
            let url = evt.detail.path;
            
            // Get the base URL from the current page's configuration
            const baseUrl = '{{ base_url }}';
            
            // URL handling for base_url configuration
            if (url && baseUrl && url.startsWith(baseUrl)) {
                const newUrl = window.location.origin + url;
                evt.detail.path = newUrl;
            }
            // Also handle any URL that starts with / but not with base_url
            else if (url && url.startsWith('/') && !url.startsWith('http')) {
                const newUrl = window.location.origin + url;
                evt.detail.path = newUrl;
            }
            
            // Ensure credentials are included in HTMX requests for authentication (with null check)
            if (evt.detail.xhr) {
                evt.detail.xhr.withCredentials = true;
            }
            
            // Add Authorization header for token-based authentication
            let token = localStorage.getItem('access_token');
            
            // Fallback to cookie if localStorage is empty
            if (!token) {
                token = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('access_token='))
                    ?.split('=')[1];
                
                if (token) {
                    localStorage.setItem('access_token', token);
                }
            }
            
            if (token) {
                evt.detail.headers['Authorization'] = 'Bearer ' + token;
            }
            
            // Debug logging for category requests
            if (evt.detail.path.includes('/discover/category/more') && evt.detail.xhr) {
                console.log('üîç HTMX Request Config:', {
                    url: evt.detail.path,
                    withCredentials: evt.detail.xhr.withCredentials,
                    headers: evt.detail.headers
                });
            }
        });
    </script>
    
    <!-- Custom styles -->
    <style>
        .bg-gradient-dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Logo styling - no filters, keep original colors */
        .navbar-logo {
            transition: opacity 0.3s ease;
        }
        
        /* Logo hover effect */
        .navbar-logo:hover {
            opacity: 0.9;
        }
        
        /* Theme Variables */
        :root {
            --primary-50: 255, 247, 237;
            --primary-100: 255, 237, 213;
            --primary-200: 254, 215, 170;
            --primary-300: 253, 186, 116;
            --primary-400: 251, 146, 60;
            --primary-500: 249, 115, 22;
            --primary-600: 234, 88, 12;
            --primary-700: 194, 65, 12;
            --primary-800: 154, 52, 18;
            --primary-900: 124, 45, 18;
        }
        
        /* Dynamic Primary Colors */
        .bg-primary-500 { background-color: rgb(var(--primary-500)); }
        .bg-primary-600 { background-color: rgb(var(--primary-600)); }
        .bg-primary-700 { background-color: rgb(var(--primary-700)); }
        .text-primary-600 { color: rgb(var(--primary-600)); }
        .text-primary-700 { color: rgb(var(--primary-700)); }
        .border-primary-500 { border-color: rgb(var(--primary-500)); }
        .ring-primary-500 { --tw-ring-color: rgb(var(--primary-500)); }
        .focus\:ring-primary-500:focus { --tw-ring-color: rgb(var(--primary-500)); }
        .focus\:border-primary-500:focus { border-color: rgb(var(--primary-500)); }
        
        /* Animations for success/error messages */
        @keyframes fadeOut {
            0% { opacity: 1; }
            75% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen {% if current_user %}flex flex-col{% endif %} {% if dark_mode %}theme-dark{% endif %}">
    <!-- Navigation -->
    <nav class="bg-gradient-dark shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img src="{{ base_url }}/static/cueplex_logo_white.png" alt="CuePlex" class="h-12 w-auto object-contain navbar-logo" />
                    </div>
                    {% if current_user %}
                    <!-- Desktop Navigation -->
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{{ base_url }}/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Search</a>
                            <a href="{{ base_url }}/requests/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Requests</a>
                            {% if user_permissions.can_manage_settings or user_permissions.can_manage_users or user_permissions.can_approve_requests or user_permissions.can_library_sync %}
                            <a href="{{ base_url }}/admin/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">‚öôÔ∏è Admin</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center">
                    {% if current_user %}
                    <!-- Dark Mode Toggle -->
                    <button 
                        onclick="toggleDarkMode()"
                        class="text-gray-300 hover:text-white p-2 rounded-md text-sm font-medium transition-colors duration-200 mr-2"
                        title="Toggle dark mode"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            {% if dark_mode %}
                            <!-- Sun icon for dark mode (to switch to light) -->
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            {% else %}
                            <!-- Moon icon for light mode (to switch to dark) -->
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            {% endif %}
                        </svg>
                    </button>
                    
                    <!-- Desktop User Info -->
                    <div class="hidden md:flex items-center space-x-4">
                        <span class="text-gray-300 text-sm">Welcome, {{ current_user.full_name or current_user.username }}</span>
                        {% if user_is_admin %}
                        <span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">Admin</span>
                        {% endif %}
                        {% if current_user.plex_id and current_user.plex_id < 0 %}
                        <span class="bg-purple-600 text-white px-2 py-1 rounded text-xs">Test User</span>
                        <a href="{{ base_url }}/admin" class="bg-primary-600 hover:bg-primary-700 text-white px-2 py-1 rounded text-xs">Return to Admin</a>
                        {% endif %}
                        <a href="{{ base_url }}/logout" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Logout</a>
                    </div>
                    
                    <!-- Mobile Hamburger Menu Button -->
                    <div class="md:hidden">
                        <button 
                            id="mobile-nav-toggle"
                            onclick="toggleMobileNavigation()"
                            class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md transition-all duration-200 relative z-50"
                            aria-label="Toggle navigation menu"
                            aria-expanded="false"
                            type="button"
                        >
                            <svg id="nav-hamburger-icon" class="w-6 h-6 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                            <svg id="nav-close-icon" class="w-6 h-6 hidden transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    {% else %}
                    <a href="{{ base_url }}/login" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Login with Plex
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% if current_user %}
            <!-- Mobile Navigation Menu -->
            <div 
                id="mobile-nav-menu"
                class="md:hidden hidden bg-gray-800 border-t border-gray-700 pb-4 pt-3 relative z-40"
            >
                <div class="px-2 space-y-1">
                    <a href="{{ base_url }}/" 
                       onclick="closeMobileNavigation()" 
                       class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-3 rounded-md text-base font-medium transition-all duration-200 min-h-[44px] flex items-center">
                        üîç Search
                    </a>
                    <a href="{{ base_url }}/requests/" 
                       onclick="closeMobileNavigation()" 
                       class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-3 rounded-md text-base font-medium transition-all duration-200 min-h-[44px] flex items-center">
                        üìã Requests
                    </a>
                    {% if user_permissions.can_manage_settings or user_permissions.can_manage_users or user_permissions.can_approve_requests or user_permissions.can_library_sync %}
                    <a href="{{ base_url }}/admin/" 
                       onclick="closeMobileNavigation()" 
                       class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-3 rounded-md text-base font-medium transition-all duration-200 min-h-[44px] flex items-center">
                        ‚öôÔ∏è Admin
                    </a>
                    {% endif %}
                </div>
                
                <!-- Mobile User Info -->
                <div class="pt-4 pb-3 border-t border-gray-700 mt-4">
                    <div class="px-5 mb-3">
                        <div class="text-gray-300 text-sm font-medium mb-2">üë§ {{ current_user.full_name or current_user.username }}</div>
                        <div class="flex flex-wrap gap-2">
                            {% if user_is_admin %}
                            <span class="bg-yellow-600 text-white px-2 py-1 rounded-full text-xs font-medium">Admin</span>
                            {% endif %}
                            {% if current_user.plex_id and current_user.plex_id < 0 %}
                            <span class="bg-purple-600 text-white px-2 py-1 rounded-full text-xs font-medium">Test User</span>
                            {% endif %}
                        </div>
                        {% if current_user.plex_id and current_user.plex_id < 0 %}
                        <div class="mt-3">
                            <a href="{{ base_url }}/admin" 
                               onclick="closeMobileNavigation()" 
                               class="bg-primary-600 hover:bg-primary-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 inline-block">
                                Return to Admin
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="px-2">
                        <button 
                            onclick="toggleDarkMode()"
                            class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-3 rounded-md text-base font-medium transition-all duration-200 min-h-[44px] flex items-center w-full text-left"
                        >
                            {% if dark_mode %}
                            ‚òÄÔ∏è Light Mode
                            {% else %}
                            üåô Dark Mode
                            {% endif %}
                        </button>
                        <a href="{{ base_url }}/logout" 
                           onclick="closeMobileNavigation()" 
                           class="text-gray-300 hover:text-white hover:bg-gray-700 block px-3 py-3 rounded-md text-base font-medium transition-all duration-200 min-h-[44px] flex items-center">
                            üö™ Logout
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Main content -->
    <main class="{% if current_user %}flex-1 overflow-hidden{% else %}max-w-7xl mx-auto py-6 sm:px-6 lg:px-8{% endif %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Toast notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Simple toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 max-w-sm`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Sync token from cookie to localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get token from cookie
            const cookieToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('access_token='))
                ?.split('=')[1];
            
            if (cookieToken && !localStorage.getItem('access_token')) {
                localStorage.setItem('access_token', cookieToken);
            }
        });

        // Activity-based token refresh to prevent sessions from expiring during active use
        let lastActivity = Date.now();
        
        function updateActivity() {
            lastActivity = Date.now();
        }
        
        function checkTokenRefresh() {
            const now = Date.now();
            const timeSinceActivity = now - lastActivity;
            const TOKEN_REFRESH_INTERVAL = 20 * 60 * 1000; // 20 minutes
            const ACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes of inactivity
            
            // If user has been active recently (within 30 min) and we haven't refreshed in 20 min
            if (timeSinceActivity < ACTIVITY_TIMEOUT && 
                (!window.lastTokenRefresh || (now - window.lastTokenRefresh) > TOKEN_REFRESH_INTERVAL)) {
                
                // Make a simple request to refresh the token (reuse existing endpoint)
                fetch('{{ base_url }}/', {
                    method: 'HEAD',
                    credentials: 'include'
                }).then(response => {
                    if (response.ok) {
                        window.lastTokenRefresh = now;
                        console.log('üîÑ Session activity verified');
                    }
                }).catch(e => {
                    // Silently fail - normal expiration handling will take over
                    console.log('Session check failed:', e);
                });
            }
        }
        
        // Track user activity
        ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });
        
        // Check for token refresh every 5 minutes
        setInterval(checkTokenRefresh, 5 * 60 * 1000);
        
        // Removed duplicate HTMX configRequest listener - consolidated above

        // HTMX event listeners
        document.addEventListener('htmx:responseError', function(event) {
            const response = event.detail.xhr;
            
            // Handle 401 Unauthorized (token expired/invalid)
            if (response.status === 401) {
                // Clear expired tokens
                localStorage.removeItem('access_token');
                document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
                
                // Show specific message and redirect to login
                showToast('Your session has expired. Redirecting to login...', 'warning');
                setTimeout(() => {
                    window.location.href = '{{ base_url }}/login';
                }, 1000);
                return;
            }
            
            // Generic error handling for other status codes
            showToast('An error occurred. Please try again.', 'error');
        });
        
        document.addEventListener('htmx:sendError', function(event) {
            showToast('Network error. Please check your connection.', 'error');
        });
        
        // Enhanced HTMX event handling for better UX
        document.addEventListener('htmx:afterRequest', function(event) {
            const response = event.detail.xhr;
            const headers = event.detail.requestConfig.headers || {};
            
            // Skip if request has X-Skip-Global-Toast header
            if (headers['X-Skip-Global-Toast'] === 'true') {
                return;
            }
            
            // Only show success toast for POST/PUT/DELETE operations (not GET requests)
            const method = event.detail.requestConfig.verb.toLowerCase();
            if (response.status === 200 && 
                ['post', 'put', 'delete'].includes(method) && 
                response.responseText.includes('successfully')) {
                showToast('Operation completed successfully!', 'success');
            }
        });

        // Global state for category expansion
        let isExpanded = false;
        let expandedHistoryState = null;

        // Category expansion function - available globally
        window.expandCategoryView = function(type, sort, title) {
            
            // Set expanded state
            isExpanded = true;
            
            // Create a history entry ONLY when expanding (not when going back)
            if (!expandedHistoryState) {
                expandedHistoryState = { expanded: true, type: type, sort: sort, title: title };
                const baseUrl = '{{ base_url }}';
                
                // Handle different URL patterns for different category types
                let historyUrl;
                if (type.startsWith('custom_')) {
                    // For custom categories, use a more descriptive URL
                    historyUrl = baseUrl + '/discover/category/' + type + '/' + sort;
                } else {
                    // For other categories, use the standard pattern
                    historyUrl = baseUrl + '/discover/' + type + '/' + sort;
                }
                
                history.pushState(expandedHistoryState, title, historyUrl);
            }
            
            // For custom categories, we need to load the expanded view first to get the correct media type
            // The backend will handle loading the saved filters and using the correct media type
            const baseUrl = '{{ base_url }}';
            
            // Handle different category types with appropriate parameters
            if (type === 'plex' || type === 'requests' || type === 'recommendations') {
                // Database categories: default to movie media type with db_category parameters
                let mediaType = 'movie';
                let expandUrl = baseUrl + '/discover/category/expanded?type=' + mediaType + '&sort=' + sort + '&limit=40&page=1';
                expandUrl += '&db_category_type=' + type + '&db_category_sort=' + sort;
                let filterUrl = baseUrl + '/discover/filters?media_type=' + mediaType;
                filterUrl += '&db_category_type=' + type + '&db_category_sort=' + sort;
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            } else if (type.startsWith('custom_')) {
                // Custom categories: Let the backend determine the correct media type from saved filters
                let customCategoryId = type.replace('custom_', '');
                let expandUrl = baseUrl + '/discover/category/expanded?sort=' + sort + '&limit=40&page=1';
                expandUrl += '&custom_category_id=' + customCategoryId;
                let filterUrl = baseUrl + '/discover/filters?custom_category_id=' + customCategoryId;
                
                console.log('üéØ Loading custom category:', customCategoryId);
                console.log('üéØ Expand URL:', expandUrl);
                console.log('üéØ Filter URL:', filterUrl);
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            } else {
                // Content source categories (trending, popular, top_rated, upcoming)
                // For these, type is actually the media_type (movie/tv)
                let expandUrl = baseUrl + '/discover/category/expanded?type=' + type + '&media_type=' + type + '&sort=' + sort + '&limit=40&page=1';
                expandUrl += '&content_sources=' + sort;
                let filterUrl = baseUrl + '/discover/filters?media_type=' + type;
                filterUrl += '&content_sources=' + sort;
                
                htmx.ajax('GET', expandUrl, {
                    target: '#categories-container', 
                    swap: 'innerHTML'
                });
                
                htmx.ajax('GET', filterUrl, {
                    target: '#filter-form-container', 
                    swap: 'innerHTML'
                });
            }
            
            // Scroll to top
            setTimeout(() => {
                const container = document.getElementById('categories-container');
                if (container) {
                    container.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            }, 100);
        }

        // Back to categories function - available globally
        window.backToCategoriesView = function() {
            
            // Clear expanded state
            isExpanded = false;
            expandedHistoryState = null;
            
            // Update URL to root
            const baseUrl = '{{ base_url }}';
            history.pushState(null, '', baseUrl + '/');
            
            // Load categories view
            htmx.ajax('GET', baseUrl + '/discover/categories', {
                target: '#categories-container', 
                swap: 'innerHTML'
            });
            
            // Reset filter bar
            htmx.ajax('GET', baseUrl + '/discover/filters', {
                target: '#filter-form-container', 
                swap: 'innerHTML'
            });
            
            // Scroll to top
            setTimeout(() => {
                const container = document.getElementById('categories-container');
                if (container) {
                    container.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            }, 100);
        }


        // Browser back button support
        window.addEventListener('popstate', function(event) {
            if (isExpanded) {
                // If we're in expanded view and browser back is pressed, collapse
                backToCategoriesView();
            }
        });

        // Category customization functionality
        let isCustomizeMode = false;

        // Clear any cached category data on page load
        Object.keys(sessionStorage).forEach(key => {
            if (key.startsWith('category-cache-')) {
                sessionStorage.removeItem(key);
            }
        });
        // Clear everything to be sure
        sessionStorage.clear();
        localStorage.clear();
        

        // Global function for category customization
        window.toggleCustomizeMode = function() {
            const button = document.getElementById('reorder-toggle');
            const categoriesContainer = document.getElementById('categories-container');
            
            if (!isCustomizeMode) {
                // Enter customize mode
                isCustomizeMode = true;
                
                if (button) {
                    button.textContent = 'üíæ Save Changes';
                    button.classList.add('bg-orange-100', 'text-orange-700');
                    button.classList.remove('bg-gray-100', 'text-gray-700');
                }
                
                const baseUrl = '{{ base_url }}';
                const url = baseUrl + '/discover/categories/customize-mode';
                
                // Load customize mode interface
                htmx.ajax('GET', url, {
                    target: '#categories-container',
                    swap: 'innerHTML'
                });
            } else {
                // Exit customize mode and save changes
                isCustomizeMode = false;
                
                if (button) {
                    button.textContent = 'üì± Customize';
                    button.classList.remove('bg-orange-100', 'text-orange-700');
                    button.classList.add('bg-gray-100', 'text-gray-700');
                }
                
                // Save the current state and reload normal view
                saveCategoryCustomizations();
            }
        };

        window.saveCategoryCustomizations = function() {
            // Collect all visible category preferences from the customization interface
            const categoryItems = document.querySelectorAll('.customize-category-item');
            
            // Get all available categories to mark hidden ones
            const allCategoryIds = ['recently-added', 'recent-requests', 'trending-movies', 'popular-movies', 'trending-tv', 'popular-tv', 'top-rated-movies', 'upcoming-movies', 'top-rated-tv'];
            const visibleCategoryIds = [];
            const customizations = {};
            
            categoryItems.forEach((item, index) => {
                const categoryId = item.dataset.categoryId;
                const displayOrder = index + 1; // Use position in list as order
                
                visibleCategoryIds.push(categoryId);
                customizations[`${categoryId}_visible`] = 'on';
                customizations[`${categoryId}_order`] = displayOrder.toString();
            });
            
            // Mark categories that are not in the visible list as hidden
            allCategoryIds.forEach(categoryId => {
                if (!visibleCategoryIds.includes(categoryId)) {
                    customizations[`${categoryId}_visible`] = 'off';
                    customizations[`${categoryId}_order`] = '0';
                }
            });
            
            
            // Reset customize mode state immediately
            isCustomizeMode = false;
            const button = document.getElementById('reorder-toggle');
            if (button) {
                button.textContent = 'üì± Customize';
                button.classList.remove('bg-orange-100', 'text-orange-700');
                button.classList.add('bg-gray-100', 'text-gray-700');
            }
            
            // Submit customizations
            const baseUrl = '{{ base_url }}';
            htmx.ajax('POST', baseUrl + '/discover/categories/save-customizations', {
                target: '#categories-container',
                swap: 'innerHTML',
                values: customizations
            }).then(() => {
                // Show success message
                showToast('Categories saved successfully!', 'success');
            }).catch((error) => {
                showToast('Error saving categories. Please try again.', 'error');
                
                // Reset customize mode on error
                isCustomizeMode = true;
                if (button) {
                    button.textContent = 'üíæ Save Changes';
                    button.classList.add('bg-orange-100', 'text-orange-700');
                    button.classList.remove('bg-gray-100', 'text-gray-700');
                }
            });
        };

        window.cancelCustomizeMode = function() {
            const button = document.getElementById('reorder-toggle');
            
            isCustomizeMode = false;
            if (button) {
                button.textContent = 'üì± Customize';
                button.classList.remove('bg-orange-100', 'text-orange-700');
                button.classList.add('bg-gray-100', 'text-gray-700');
            }
            
            // Reload normal categories view
            const baseUrl = '{{ base_url }}';
            htmx.ajax('GET', baseUrl + '/discover/categories', {
                target: '#categories-container',
                swap: 'innerHTML'
            });
        };

        
        // Also add click event listener as backup
        document.addEventListener('DOMContentLoaded', function() {
            const customizeBtn = document.getElementById('reorder-toggle');
            if (customizeBtn) {
                customizeBtn.addEventListener('click', function() {
                    window.toggleCustomizeMode();
                });
            } else {
                // Try again after a delay in case it's loaded by HTMX
                setTimeout(function() {
                    const delayedBtn = document.getElementById('reorder-toggle');
                    if (delayedBtn) {
                        delayedBtn.addEventListener('click', function() {
                            window.toggleCustomizeMode();
                        });
                    }
                }, 1000);
            }
        });

        // Simple and reliable dropdown positioning
        window.toggleDropdownMenu = function(button) {
            const dropdown = button.nextElementSibling;
            const isHidden = dropdown.classList.contains('hidden');
            
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-menu').forEach(function(d) {
                if (d !== dropdown) {
                    d.classList.add('hidden');
                }
            });
            
            if (isHidden) {
                // Move dropdown to body to completely escape all container constraints
                if (dropdown.parentNode !== document.body) {
                    // Store original parent and position for cleanup
                    dropdown._originalParent = dropdown.parentNode;
                    dropdown._originalNextSibling = dropdown.nextSibling;
                    document.body.appendChild(dropdown);
                }
                
                // Show dropdown and position it
                dropdown.classList.remove('hidden');
                
                // Get button position relative to viewport
                const buttonRect = button.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Position dropdown with fixed positioning
                dropdown.style.position = 'fixed';
                dropdown.style.zIndex = '2147483647'; // Maximum z-index
                
                // Set minimum width to match button, but allow it to be wider if needed
                const minWidth = Math.max(buttonRect.width, 160);
                dropdown.style.minWidth = minWidth + 'px';
                
                // Calculate horizontal position (prefer left-aligned with button)
                let leftPos = buttonRect.left;
                
                // If dropdown would go off right edge, adjust position
                if (leftPos + minWidth > viewportWidth - 20) {
                    leftPos = Math.max(20, viewportWidth - minWidth - 20);
                }
                
                dropdown.style.left = leftPos + 'px';
                
                // Calculate vertical position (prefer below button)
                let topPos = buttonRect.bottom + 4;
                
                // If dropdown would go off bottom edge, show above button instead
                const dropdownHeight = dropdown.offsetHeight || 200; // estimate if not measured yet
                if (topPos + dropdownHeight > viewportHeight - 20 && buttonRect.top > dropdownHeight + 20) {
                    topPos = buttonRect.top - dropdownHeight - 4;
                }
                
                dropdown.style.top = Math.max(20, topPos) + 'px';
                
            } else {
                // Hide dropdown and return to original position
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            }
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Check if the click is outside all dropdown triggers and menus
            if (!event.target.closest('button[onclick*="toggleDropdownMenu"]') && 
                !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                    dropdown.classList.add('hidden');
                    
                    // Return dropdown to its original parent if it was moved to body
                    if (dropdown._originalParent && dropdown.parentNode === document.body) {
                        if (dropdown._originalNextSibling) {
                            dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                        } else {
                            dropdown._originalParent.appendChild(dropdown);
                        }
                    }
                });
            }
        });
        
        // Close dropdowns on scroll to prevent positioning issues
        document.addEventListener('scroll', function() {
            // Close generic dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
            
            // Close approval dropdowns
            document.querySelectorAll('[id^="approval-dropdown-"]').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
        }, true);
        
        // Global function to close all dropdowns (used by dropdown buttons)
        window.closeAllDropdowns = function() {
            // Close generic dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
            
            // Close approval dropdowns
            document.querySelectorAll('[id^="approval-dropdown-"]').forEach(function(dropdown) {
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved to body
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            });
        };

        // Mobile navigation functionality
        window.toggleMobileNavigation = function() {
            const mobileMenu = document.getElementById('mobile-nav-menu');
            const toggleBtn = document.getElementById('mobile-nav-toggle');
            const hamburgerIcon = document.getElementById('nav-hamburger-icon');
            const closeIcon = document.getElementById('nav-close-icon');
            
            if (mobileMenu && toggleBtn && hamburgerIcon && closeIcon) {
                const isHidden = mobileMenu.classList.contains('hidden');
                
                if (isHidden) {
                    // Show mobile menu
                    mobileMenu.classList.remove('hidden');
                    hamburgerIcon.classList.add('hidden');
                    closeIcon.classList.remove('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'true');
                    
                    // Prevent body scroll when menu is open
                    document.body.style.overflow = 'hidden';
                } else {
                    // Hide mobile menu
                    mobileMenu.classList.add('hidden');
                    hamburgerIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                    
                    // Restore body scroll
                    document.body.style.overflow = '';
                }
            }
        };

        // Close mobile navigation function
        window.closeMobileNavigation = function() {
            const mobileMenu = document.getElementById('mobile-nav-menu');
            const toggleBtn = document.getElementById('mobile-nav-toggle');
            const hamburgerIcon = document.getElementById('nav-hamburger-icon');
            const closeIcon = document.getElementById('nav-close-icon');
            
            if (mobileMenu && toggleBtn && hamburgerIcon && closeIcon) {
                mobileMenu.classList.add('hidden');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                toggleBtn.setAttribute('aria-expanded', 'false');
                
                // Restore body scroll
                document.body.style.overflow = '';
            }
        };

        // Close mobile navigation when window is resized to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) { // md breakpoint
                closeMobileNavigation();
            }
        });

        // Close mobile navigation when clicking outside (on mobile)
        document.addEventListener('click', function(event) {
            if (window.innerWidth < 768) { // Only on mobile
                const mobileMenu = document.getElementById('mobile-nav-menu');
                const toggleBtn = document.getElementById('mobile-nav-toggle');
                
                if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    // Check if click is outside both the menu and toggle button
                    if (!mobileMenu.contains(event.target) && !toggleBtn.contains(event.target)) {
                        closeMobileNavigation();
                    }
                }
            }
        });

        // Handle escape key to close mobile menu
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const mobileMenu = document.getElementById('mobile-nav-menu');
                if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    closeMobileNavigation();
                }
            }
        });

        // Dark mode toggle function
        async function toggleDarkMode() {
            try {
                const response = await fetch('{{ base_url }}/user/toggle-dark-mode', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + (localStorage.getItem('access_token') || ''),
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Refresh the page to apply the new theme
                    window.location.reload();
                } else {
                    showToast(result.error || 'Failed to toggle dark mode', 'error');
                }
            } catch (error) {
                showToast('Error toggling dark mode', 'error');
                console.error('Dark mode toggle error:', error);
            }
        }

        // Approval dropdown toggle function - uses same robust positioning as generic dropdowns
        window.toggleApprovalDropdown = function(requestId) {
            const dropdown = document.getElementById('approval-dropdown-' + requestId);
            const button = event.target.closest('button');
            const isHidden = dropdown.classList.contains('hidden');
            
            // Close all other approval dropdowns first
            document.querySelectorAll('[id^="approval-dropdown-"]').forEach(function(d) {
                if (d !== dropdown) {
                    d.classList.add('hidden');
                    // Return dropdown to original position if it was moved
                    if (d._originalParent && d.parentNode === document.body) {
                        if (d._originalNextSibling) {
                            d._originalParent.insertBefore(d, d._originalNextSibling);
                        } else {
                            d._originalParent.appendChild(d);
                        }
                    }
                }
            });
            
            if (isHidden) {
                // Move dropdown to body to completely escape all container constraints
                if (dropdown.parentNode !== document.body) {
                    // Store original parent and position for cleanup
                    dropdown._originalParent = dropdown.parentNode;
                    dropdown._originalNextSibling = dropdown.nextSibling;
                    document.body.appendChild(dropdown);
                }
                
                // Show dropdown and position it
                dropdown.classList.remove('hidden');
                
                // Get button position relative to viewport
                const buttonRect = button.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Position dropdown with fixed positioning
                dropdown.style.position = 'fixed';
                dropdown.style.zIndex = '2147483647'; // Maximum z-index
                
                // Set width to match expected dropdown width (w-72 = 288px)
                const dropdownWidth = 288;
                dropdown.style.width = dropdownWidth + 'px';
                
                // Calculate horizontal position (prefer right-aligned with button for approval dropdown)
                let leftPos = buttonRect.right - dropdownWidth;
                
                // If dropdown would go off left edge, align with left edge of button
                if (leftPos < 20) {
                    leftPos = buttonRect.left;
                }
                
                // If still going off right edge, position as far right as possible
                if (leftPos + dropdownWidth > viewportWidth - 20) {
                    leftPos = Math.max(20, viewportWidth - dropdownWidth - 20);
                }
                
                dropdown.style.left = leftPos + 'px';
                
                // Calculate vertical position (prefer below button)
                let topPos = buttonRect.bottom + 4;
                
                // If dropdown would go off bottom edge, show above button instead
                const dropdownHeight = dropdown.offsetHeight || 200; // estimate if not measured yet
                if (topPos + dropdownHeight > viewportHeight - 20 && buttonRect.top > dropdownHeight + 20) {
                    topPos = buttonRect.top - dropdownHeight - 4;
                }
                
                dropdown.style.top = Math.max(20, topPos) + 'px';
                
            } else {
                // Hide dropdown and return to original position
                dropdown.classList.add('hidden');
                
                // Return dropdown to its original parent if it was moved
                if (dropdown._originalParent && dropdown.parentNode === document.body) {
                    if (dropdown._originalNextSibling) {
                        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                    } else {
                        dropdown._originalParent.appendChild(dropdown);
                    }
                }
            }
        }

        // Close approval dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[id^="approval-dropdown-"]') && 
                !event.target.closest('button[onclick*="toggleApprovalDropdown"]')) {
                document.querySelectorAll('[id^="approval-dropdown-"]').forEach(function(dropdown) {
                    dropdown.classList.add('hidden');
                    
                    // Return dropdown to its original parent if it was moved to body
                    if (dropdown._originalParent && dropdown.parentNode === document.body) {
                        if (dropdown._originalNextSibling) {
                            dropdown._originalParent.insertBefore(dropdown, dropdown._originalNextSibling);
                        } else {
                            dropdown._originalParent.appendChild(dropdown);
                        }
                    }
                });
            }
        });
    </script>
    
    <!-- Enhanced dropdown styling to match site aesthetic -->
    <style>
        /* Force dropdown menus to appear above all other content with beautiful styling */  
        .dropdown-menu,
        [id^="approval-dropdown-"] {
            position: fixed !important;
            z-index: 2147483647 !important; /* Maximum possible z-index */
            
            /* Enhanced visual styling */
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%) !important;
            border: 1px solid rgba(59, 130, 246, 0.15) !important;
            border-radius: 12px !important;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(255, 255, 255, 0.05) !important;
            
            /* Animation and transitions */
            opacity: 0 !important;
            transform: translateY(-8px) scale(0.95) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            backdrop-filter: blur(8px) !important;
            
            /* Typography */
            font-family: system-ui, -apple-system, sans-serif !important;
        }
        
        /* Show animation for dropdown */
        .dropdown-menu:not(.hidden),
        [id^="approval-dropdown-"]:not(.hidden) {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }
        
        /* Enhanced dropdown button styling within dropdown */
        .dropdown-menu button,
        [id^="approval-dropdown-"] button {
            transition: all 0.15s ease !important;
            border-radius: 8px !important;
            margin: 2px !important;
            font-weight: 500 !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .dropdown-menu button:hover,
        [id^="approval-dropdown-"] button:hover {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
            color: white !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 8px 15px -3px rgba(249, 115, 22, 0.3) !important;
        }
        
        .dropdown-menu button:active,
        [id^="approval-dropdown-"] button:active {
            transform: translateY(0) !important;
            box-shadow: 0 4px 8px -2px rgba(249, 115, 22, 0.4) !important;
        }
        
        /* Quality tier and category badges in dropdown */
        .dropdown-menu .bg-blue-100,
        [id^="approval-dropdown-"] .bg-blue-100 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            color: #1e40af !important;
            font-weight: 600 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(59, 130, 246, 0.2) !important;
        }
        
        .dropdown-menu .bg-gray-100,
        [id^="approval-dropdown-"] .bg-gray-100 {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
            color: #374151 !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(107, 114, 128, 0.15) !important;
        }
        
        /* Ensure dropdown triggers have appropriate stacking and enhanced styling */
        button[onclick*="toggleDropdownMenu"] {
            position: relative !important;
            z-index: 10 !important;
            transition: all 0.2s ease !important;
        }
        
        button[onclick*="toggleDropdownMenu"]:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 8px 15px -3px rgba(249, 115, 22, 0.4) !important;
        }
        
        button[onclick*="toggleDropdownMenu"]:active {
            transform: translateY(0) !important;
        }
        
        /* Prevent any overflow hidden from affecting dropdowns */
        .media-card,
        .movie-card-horizontal,
        [data-dropdown-boundary] {
            overflow: visible !important;
        }
        
        /* Ensure containers don't create new stacking contexts that interfere */
        .flex[style*="overflow-x"],  
        .grid {
            contain: layout style !important;
        }
        
        /* Add subtle loading state for dropdown items */
        .dropdown-menu form,
        [id^="approval-dropdown-"] form {
            position: relative !important;
        }
        
        .dropdown-menu form::after,
        [id^="approval-dropdown-"] form::after {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.1), transparent) !important;
            transform: translateX(-100%) !important;
            transition: transform 0.6s ease !important;
            pointer-events: none !important;
            opacity: 0 !important;
        }
        
        .dropdown-menu form:hover::after,
        [id^="approval-dropdown-"] form:hover::after {
            transform: translateX(100%) !important;
            opacity: 1 !important;
        }
        
        /* Mobile Navigation Styling */
        #mobile-nav-menu {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        #mobile-nav-menu.hidden {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
            }
        }
        
        /* Enhanced mobile nav button styling */
        #mobile-nav-toggle {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        #mobile-nav-toggle:active {
            transform: scale(0.95);
        }
        
        /* Ensure mobile nav links have proper touch targets and enhanced styling */
        #mobile-nav-menu a {
            min-height: 44px;
            display: flex;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
        }
        
        #mobile-nav-menu a:hover {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            transform: translateX(4px);
            box-shadow: inset 4px 0 0 0 rgba(249, 115, 22, 0.6);
        }
        
        #mobile-nav-menu a:active {
            transform: translateX(2px) scale(0.98);
        }
        
        /* Add subtle ripple effect for touch interactions */
        #mobile-nav-menu a::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(249, 115, 22, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
            pointer-events: none;
        }
        
        #mobile-nav-menu a:active::before {
            width: 100%;
            height: 100%;
        }
        
        /* Enhanced badge styling for mobile */
        #mobile-nav-menu .bg-yellow-600,
        #mobile-nav-menu .bg-purple-600 {
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Backdrop blur effect for mobile menu */
        #mobile-nav-menu {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 640px) {
            .dropdown-menu,
            [id^="approval-dropdown-"] {
                max-width: calc(100vw - 40px) !important;
                left: 20px !important;
                right: 20px !important;
                width: auto !important;
                border-radius: 16px !important;
            }
            
            .dropdown-menu button,
            [id^="approval-dropdown-"] button {
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
        }
        
        /* Dark mode compatibility (if ever implemented) */
        @media (prefers-color-scheme: dark) {
            .dropdown-menu,
            [id^="approval-dropdown-"] {
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
                border-color: rgba(75, 85, 99, 0.3) !important;
                color: #f9fafb !important;
            }
        }
    </style>
</body>
</html>